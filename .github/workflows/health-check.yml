name: Production Health Check

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:  # Manual trigger

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Frontend
        id: frontend
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://lottery-frontend-chi.vercel.app)
          echo "status=$response" >> $GITHUB_OUTPUT
          if [ "$response" != "200" ]; then
            echo "‚ùå Frontend health check failed with status: $response"
            exit 1
          fi
          echo "‚úÖ Frontend is healthy (status: $response)"
          
      - name: Check Backend Connectivity
        run: |
          echo "Testing backend connectivity from frontend perspective..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://lottery-backend-gm4j.onrender.com/api/health)
          if [ "$response" != "200" ]; then
            echo "‚ö†Ô∏è Backend appears to be down (status: $response)"
            echo "This may cause frontend issues"
          else
            echo "‚úÖ Backend is reachable"
          fi
          
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'üö® Frontend Production Health Check Failed';
            const body = `
            ## Automated Health Check Alert
            
            **Time:** ${new Date().toISOString()}
            **Status:** Frontend appears to be down or unhealthy
            
            ### Actions to take:
            1. Check Vercel dashboard for deployment errors
            2. Review recent deployments
            3. Check if backend is accessible
            
            This issue was automatically created by the health check workflow.
            `;
            
            // Check if similar issue exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-check-alert'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['bug', 'urgent', 'health-check-alert']
              });
            }
