// Prisma schema for Gamification features
// This extends the existing Supabase tables with new gamification models

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// GAMIFICATION MODELS
// ============================================

// User Profile Extension (links to existing User table)
model UserProfile {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @unique
  walletAddress   String?
  level           Int      @default(1)
  xp              Int      @default(0)
  totalTickets    Int      @default(0)
  totalWinnings   Decimal  @default(0) @db.Decimal
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  referralCode     ReferralCode?
  referralsGiven   ReferralRelationship[] @relation("Referrer")
  referralsReceived ReferralRelationship[] @relation("Referred")
  quests           UserQuest[]
  achievements     UserAchievement[]
  streak           UserStreak?
  rewards          UserReward[]

  @@map("UserProfile")
}

// ============================================
// REFERRAL SYSTEM
// ============================================

model ReferralCode {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @unique
  code            String   @unique
  usageCount      Int      @default(0)
  maxUsage        Int?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  expiresAt       DateTime?

  // Relations
  userProfile     UserProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)
  relationships   ReferralRelationship[]

  @@index([code])
  @@map("ReferralCode")
}

model ReferralRelationship {
  id              String   @id @default(uuid()) @db.Uuid
  referrerId      String
  referredId      String
  referralCodeId  String   @db.Uuid
  status          String   @default("pending") // pending, active, completed
  rewardClaimed   Boolean  @default(false)
  createdAt       DateTime @default(now())

  // Relations
  referrer        UserProfile @relation("Referrer", fields: [referrerId], references: [userId], onDelete: Cascade)
  referred        UserProfile @relation("Referred", fields: [referredId], references: [userId], onDelete: Cascade)
  referralCode    ReferralCode @relation(fields: [referralCodeId], references: [id], onDelete: Cascade)
  rewards         ReferralReward[]

  @@unique([referrerId, referredId])
  @@index([referrerId])
  @@index([referredId])
  @@map("ReferralRelationship")
}

model ReferralReward {
  id              String   @id @default(uuid()) @db.Uuid
  relationshipId  String   @db.Uuid
  type            String   // bonus_tickets, xp_boost, discount
  value           Decimal  @db.Decimal
  claimed         Boolean  @default(false)
  claimedAt       DateTime?
  createdAt       DateTime @default(now())
  expiresAt       DateTime?

  // Relations
  relationship    ReferralRelationship @relation(fields: [relationshipId], references: [id], onDelete: Cascade)

  @@index([relationshipId])
  @@map("ReferralReward")
}

// ============================================
// QUEST SYSTEM
// ============================================

model Quest {
  id              String   @id @default(uuid()) @db.Uuid
  title           String
  description     String
  type            String   // daily, weekly, monthly, special
  category        String   // tickets, referrals, streak, social
  target          Int      // target value to complete
  reward          Json     // { type: 'xp' | 'tickets' | 'discount', value: number }
  difficulty      String   @default("easy") // easy, medium, hard
  isActive        Boolean  @default(true)
  startDate       DateTime?
  endDate         DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  userQuests      UserQuest[]

  @@index([type, isActive])
  @@index([category])
  @@map("Quest")
}

model UserQuest {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String
  questId         String   @db.Uuid
  progress        Int      @default(0)
  isCompleted     Boolean  @default(false)
  completedAt     DateTime?
  rewardClaimed   Boolean  @default(false)
  claimedAt       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  userProfile     UserProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)
  quest           Quest @relation(fields: [questId], references: [id], onDelete: Cascade)

  @@unique([userId, questId])
  @@index([userId])
  @@index([questId])
  @@index([isCompleted])
  @@map("UserQuest")
}

// ============================================
// ACHIEVEMENT SYSTEM
// ============================================

model Achievement {
  id              String   @id @default(uuid()) @db.Uuid
  name            String   @unique
  title           String
  description     String
  category        String   // tickets, wins, referrals, streak, level
  tier            String   @default("bronze") // bronze, silver, gold, diamond, platinum
  requirement     Json     // { type: string, value: number }
  reward          Json     // { type: string, value: number }
  icon            String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  userAchievements UserAchievement[]

  @@index([category])
  @@index([tier])
  @@map("Achievement")
}

model UserAchievement {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String
  achievementId   String   @db.Uuid
  unlockedAt      DateTime @default(now())
  progress        Int      @default(0)
  rewardClaimed   Boolean  @default(false)
  claimedAt       DateTime?

  // Relations
  userProfile     UserProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)
  achievement     Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
  @@map("UserAchievement")
}

// ============================================
// STREAK SYSTEM
// ============================================

model UserStreak {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @unique
  currentStreak   Int      @default(0)
  longestStreak   Int      @default(0)
  lastCheckIn     DateTime?
  totalCheckIns   Int      @default(0)
  streakBonus     Decimal  @default(0) @db.Decimal // accumulated bonus from streak
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  userProfile     UserProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@index([currentStreak])
  @@map("UserStreak")
}

// ============================================
// REWARD SYSTEM
// ============================================

model Reward {
  id              String   @id @default(uuid()) @db.Uuid
  type            String   // daily_bonus, level_up, achievement, quest_completion, referral
  name            String
  description     String?
  value           Decimal  @db.Decimal
  currency        String?  // TON, USDT, null for tickets
  conditions      Json?    // conditions to receive this reward
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  userRewards     UserReward[]

  @@index([type])
  @@map("Reward")
}

model UserReward {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String
  rewardId        String   @db.Uuid
  claimed         Boolean  @default(false)
  claimedAt       DateTime?
  expiresAt       DateTime?
  metadata        Json?    // additional data about the reward
  createdAt       DateTime @default(now())

  // Relations
  userProfile     UserProfile @relation(fields: [userId], references: [userId], onDelete: Cascade)
  reward          Reward @relation(fields: [rewardId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([rewardId])
  @@index([claimed])
  @@index([expiresAt])
  @@map("UserReward")
}
